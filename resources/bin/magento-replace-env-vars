#!/usr/bin/env php
<?php

$Outputs = require('configure-instance-resources.php');


$MEDIA_S3_ACCESS_KEY = getenv('MEDIA_S3_ACCESS_KEY') ? getenv('MEDIA_S3_ACCESS_KEY') : getenv('AWS_ACCESS_KEY_ID');
$MEDIA_S3_SECRET_KEY = getenv('MEDIA_S3_SECRET_KEY') ? getenv('MEDIA_S3_SECRET_KEY') : getenv('AWS_SECRET_ACCESS_KEY');
$MEDIA_S3_BUCKET = getenv('MEDIA_S3_BUCKET') ? getenv('MEDIA_S3_BUCKET') : null;
if (!$MEDIA_S3_BUCKET && $Outputs['MediaBucketName']) {
    $MEDIA_S3_BUCKET = $Outputs['MediaBucketName'];
    echo "Automatically configuring media bucket name to $MEDIA_S3_BUCKET.\n";
}

$MEDIA_S3_REGION = getenv('MEDIA_S3_REGION') ? getenv('MEDIA_S3_REGION') : 'eu-west-1';
$ELASTICACHE_CONNECTION = getenv('ELASTICACHE_CONNECTION') ? getenv('ELASTICACHE_CONNECTION') : null;

if (!$ELASTICACHE_CONNECTION && $Outputs['ElastiCacheAddress'] && $Outputs['ElastiCachePort']) {
    $ELASTICACHE_CONNECTION = $Outputs['ElastiCacheAddress'] . ':' . $Outputs['ElastiCachePort'];
    echo "Automatically configuring elasticache with $ELASTICACHE_CONNECTION\n";
}


$RDS_USERNAME = getenv('RDS_USERNAME');
$RDS_PASSWORD = getenv('RDS_PASSWORD');
$RDS_HOSTNAME = getenv('RDS_HOSTNAME');
$RDS_PORT = getenv('RDS_PORT');
$RDS_DB_NAME = getenv('RDS_DB_NAME');


$MEDIA_S3_WEBSITE_URL = getenv('MEDIA_S3_WEBSITE_URL') ? getenv('MEDIA_S3_WEBSITE_URL') : null;
if (!$MEDIA_S3_WEBSITE_URL && $Outputs['MediaWebsiteURL']) {
    $MEDIA_S3_WEBSITE_URL = $Outputs['MediaWebsiteURL'] . '/';
    echo "Automatically configuring media website url with $MEDIA_S3_WEBSITE_URL\n";
}

$MEDIA_S3_SECURE_URL = getenv('MEDIA_S3_SECURE_URL') ? getenv('MEDIA_S3_SECURE_URL') : null;
if (!$MEDIA_S3_SECURE_URL && $Outputs['MediaSecureURL']) {
    $MEDIA_S3_SECURE_URL = $Outputs['MediaSecureURL'] . '/';
    echo "Automatically configuring secure media website url with $MEDIA_S3_SECURE_URL\n";
}

echo "Setting asset minification defaults";
passthru("mysql -u \"$RDS_USERNAME\" -p\"$RDS_PASSWORD\" -h \"$RDS_HOSTNAME\" -P \"$RDS_PORT\" \"$RDS_DB_NAME\" -e \"REPLACE INTO core_config_data (value, path) VALUES
                    ('$MEDIA_S3_SECURE_URL', 'web/secure/base_media_url'), ('$MEDIA_S3_WEBSITE_URL', 'web/unsecure/base_media_url'),
                    ('0',  'dev/js/merge_files'), ('0', 'dev/js/minify_files'), ('0', 'dev/js/enable_js_bundling'),
                    ('1',  'dev/css/merge_files'), ('0', 'dev/css/minify_files'),
                    ('0', 'dev/template/minify_html');");

passthru("/src/bin/magento s3:config:set --access-key-id \"$MEDIA_S3_ACCESS_KEY\" --secret-key \"$MEDIA_S3_SECRET_KEY\" --bucket \"$MEDIA_S3_BUCKET\" --region \"$MEDIA_S3_REGION\"");


$file = getenv('APP_DIR') . '/app/etc/env.php';
$config = require($file);
$config['cache_types']['full_page'] = 1;
if ($ELASTICACHE_CONNECTION) {
    $config['session'] = array ( 'save' => 'memcached', 'save_path' => $ELASTICACHE_CONNECTION);
    list($host, $port) = explode(':', $ELASTICACHE_CONNECTION);
    $config['cache'] = array(
        'frontend' => array(
            'default' => array(
                'backend' => 'Zend_Cache_Backend_Libmemcached',
                'backend_options' => array(
                    'servers' => array(
                        array(
                            'host' => $host,
                            'port' => $port, 'weight' => 1
                        )
                    )
                )
            )
        )
    );
}


$finished = '<?php return ' . var_export($config, true) . ';';
file_put_contents($file, $finished);